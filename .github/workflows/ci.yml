name: Advanced CI Pipeline

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main" ]

env:
  DOTNET_VERSION: '8.x'
  PROJECT_PATH: 'AdvancedPipeline/src/AdvancedCalculator'
  TEST_PATH: 'AdvancedPipeline/tests/AdvancedCalculator.Tests'

jobs:
  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Check code style
      run: |
        dotnet format ${{ env.PROJECT_PATH }} --verify-no-changes --verbosity detailed

    - name: Check test code style
      run: |
        dotnet format ${{ env.TEST_PATH }} --verify-no-changes --verbosity detailed

    - name: Check compilation
      run: dotnet build --nologo --verbosity quiet

  build:
    name: Build - ${{ matrix.os }}
    needs: code-quality
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Build project
      run: dotnet build ${{ env.PROJECT_PATH }} --configuration Release --no-restore

    - name: Save artifact
      uses: actions/upload-artifact@v4
      with:
        name: build-${{ matrix.os }}
        path: ${{ env.PROJECT_PATH }}/bin/Release/
        retention-days: 7

  test:
    name: Tests with Coverage
    needs: code-quality
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Run tests with coverage
      run: |
        dotnet test ${{ env.TEST_PATH }} \
          --logger "trx;LogFileName=test-results.trx" \
          --collect:"XPlat Code Coverage" \
          --results-directory ./TestResults \
          --verbosity normal

    - name: Upload test results
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: TestResults/
        retention-days: 30

    - name: Save coverage report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: ${{ env.TEST_PATH }}/**/coverage.cobertura.xml
        retention-days: 30

  package:
    name: Create Package
    needs: [build, test]
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Create NuGet package
      run: dotnet pack ${{ env.PROJECT_PATH }} --configuration Release --output ./packages

    - name: Save packages
      uses: actions/upload-artifact@v4
      with:
        name: nuget-packages
        path: ./packages/*.nupkg
        retention-days: 30

  report:
    name: Final Report
    needs: [code-quality, build, test, package]
    runs-on: ubuntu-latest

    steps:
    - name: Generate report
      run: |
        echo "CI Pipeline completed!"
        echo "======================"
        echo "Code Quality: Checked"
        echo "Build: Completed on 3 OS"
        echo "Tests: Run with coverage"
        echo "Package: Created"
        echo ""
        echo "Time: $(date)"

    - name: Pipeline status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "All jobs completed successfully!"
        else
          echo "Some jobs failed"
          exit 1
        fi
